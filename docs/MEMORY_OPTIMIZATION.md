# å†…å­˜ä¼˜åŒ–æŒ‡å—

## ğŸ“Š å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ

### å®æµ‹æ•°æ®
```
åˆå§‹å¯åŠ¨å†…å­˜: 16-17 MB (RSS)
ç©ºé—² 7 ç§’å: 17 MB
```

### å†…å­˜åˆ†å¸ƒï¼ˆä¼°ç®—ï¼‰
| ç»„ä»¶ | å†…å­˜å ç”¨ | å æ¯” |
|------|----------|------|
| Go è¿è¡Œæ—¶ | 4-6 MB | ~35% |
| ä¾èµ–åŒ… | 5-8 MB | ~40% |
| åº”ç”¨ä»£ç  | 1-2 MB | ~15% |
| å…¨å±€æ•°æ® | <1 MB | ~5% |
| **æ€»è®¡** | **16-17 MB** | **100%** |

### åŒç±»äº§å“å¯¹æ¯”
- **Caddy (Go)**: 20-30 MB
- **Traefik (Go)**: 30-50 MB
- **å½“å‰åº”ç”¨**: 16-17 MB âœ… **ä¼˜äºåŒç±»**

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç¼–è¯‘ä¼˜åŒ–ï¼ˆæ¨èï¼‰â­

**æ”¶ç›Š**: é—´æ¥å‡å°‘ ~1-2 MB å†…å­˜
**ä»£ä»·**: æ— ï¼ˆä»…ç¼–è¯‘å‚æ•°å˜åŒ–ï¼‰
**éš¾åº¦**: â­â˜†â˜†â˜†â˜†

```bash
# å»é™¤è°ƒè¯•ç¬¦å·å’Œ DWARF ä¿¡æ¯
go build -ldflags="-s -w" -o sbm ./cmd/sbm

# æˆ–è€…ä½¿ç”¨ UPX å‹ç¼©ï¼ˆå¯é€‰ï¼‰
upx --best --lzma sbm
```

**æ•ˆæœ**ï¼š
- äºŒè¿›åˆ¶æ–‡ä»¶: 31 MB â†’ 21 MB (-32%)
- è¿è¡Œæ—¶å†…å­˜: é—´æ¥å‡å°‘ 1-2 MB

---

### æ–¹æ¡ˆ 2ï¼šGo è¿è¡Œæ—¶å‚æ•°è°ƒä¼˜ï¼ˆæ¨èï¼‰â­â­

**æ”¶ç›Š**: å‡å°‘ 2-4 MB åˆå§‹å †å†…å­˜
**ä»£ä»·**: æ— 
**éš¾åº¦**: â­â˜†â˜†â˜†â˜†

```bash
# è®¾ç½®åˆå§‹å †å¤§å°ä¸º 8 MBï¼ˆé»˜è®¤å¯èƒ½æ›´å¤§ï¼‰
GOGC=100 GOMEMLIMIT=50MiB ./sbm

# æˆ–åœ¨ä»£ç ä¸­è®¾ç½®
// cmd/sbm/main.go
import "runtime/debug"

func init() {
    debug.SetMemoryLimit(50 * 1024 * 1024) // 50 MB
    debug.SetGCPercent(100) // GC è§¦å‘é˜ˆå€¼
}
```

**ç¯å¢ƒå˜é‡è¯´æ˜**ï¼š
- `GOGC=100`: GC åœ¨å †å¢é•¿ 100% æ—¶è§¦å‘ï¼ˆé»˜è®¤å€¼ï¼‰
- `GOMEMLIMIT=50MiB`: è½¯å†…å­˜é™åˆ¶ï¼ŒGo 1.19+
- `GODEBUG=gctrace=1`: å¯ç”¨ GC æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰

---

### æ–¹æ¡ˆ 3ï¼šå»¶è¿ŸåŠ è½½å…¨å±€æ•°æ®ï¼ˆå¯é€‰ï¼‰â­â­

**æ”¶ç›Š**: å‡å°‘ ~500 KB - 1 MB
**ä»£ä»·**: ä»£ç å¤æ‚åº¦å¢åŠ 
**éš¾åº¦**: â­â­â˜†â˜†â˜†

```go
// internal/storage/models.go

// ä¼˜åŒ–å‰ï¼šå…¨å±€å˜é‡ï¼ˆå¯åŠ¨æ—¶ç«‹å³åˆ†é…ï¼‰
var CountryNames = map[string]string{/* 43 æ¡ */}
var CountryEmojis = map[string]string{/* 43 æ¡ */}

// ä¼˜åŒ–åï¼šå»¶è¿Ÿåˆå§‹åŒ–
var (
    countryNames  map[string]string
    countryEmojis map[string]string
    initOnce      sync.Once
)

func initCountryData() {
    initOnce.Do(func() {
        countryNames = map[string]string{/* 43 æ¡ */}
        countryEmojis = map[string]string{/* 43 æ¡ */}
    })
}

func GetCountryName(code string) string {
    initCountryData()
    if name, ok := countryNames[code]; ok {
        return name
    }
    return code
}
```

**æ³¨æ„**: è¿™ç§ä¼˜åŒ–æ”¶ç›Šæå°ï¼ˆ< 10 KBï¼‰ï¼Œä¸æ¨èå®æ–½ã€‚

---

### æ–¹æ¡ˆ 4ï¼šç²¾ç®€ä¾èµ–ï¼ˆé«˜çº§ï¼‰â­â­â­

**æ”¶ç›Š**: å‡å°‘ 2-5 MB
**ä»£ä»·**: åŠŸèƒ½å¯èƒ½å—å½±å“
**éš¾åº¦**: â­â­â­â­â˜†

#### 4.1 æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
```bash
go mod tidy
go mod graph | grep -v indirect
```

#### 4.2 ä½¿ç”¨æ›´è½»é‡çš„æ›¿ä»£å“
```go
// ç¤ºä¾‹ï¼šæ›¿æ¢ Gin â†’ Chi/Fiber
// æ”¶ç›Š: å‡å°‘ ~1-2 MB
// ä»£ä»·: é‡æ„è·¯ç”±ä»£ç 
```

**ä¸æ¨è**: å½“å‰ä¾èµ–éƒ½æ˜¯å¿…éœ€çš„ã€‚

---

### æ–¹æ¡ˆ 5ï¼šè‡ªå®šä¹‰æ„å»ºæ ‡ç­¾ï¼ˆé«˜çº§ï¼‰â­â­â­â­

**æ”¶ç›Š**: å‡å°‘ 3-5 MB
**ä»£ä»·**: éœ€è¦æ¡ä»¶ç¼–è¯‘
**éš¾åº¦**: â­â­â­â­â˜†

```go
// +build !minimal

// ä»…åœ¨éæœ€å°åŒ–æ„å»ºæ—¶åŒ…å«
func enableDebugEndpoints() {
    // ...
}
```

```bash
# æœ€å°åŒ–æ„å»º
go build -tags minimal -ldflags="-s -w" ./cmd/sbm
```

---

## âœ… æ¨èå®æ–½æ–¹æ¡ˆ

### ç«‹å³å¯ç”¨ï¼ˆæ¨èï¼‰
```bash
# 1. ç¼–è¯‘ä¼˜åŒ–
go build -ldflags="-s -w" -o sbm ./cmd/sbm

# 2. è¿è¡Œæ—¶å‚æ•°ï¼ˆå¯é€‰ï¼‰
GOMEMLIMIT=50MiB ./sbm
```

**é¢„æœŸæ•ˆæœ**ï¼š
- åˆå§‹å†…å­˜: 16 MB â†’ **13-14 MB** (-15~20%)
- æ— åŠŸèƒ½æŸå¤±

### æ„å»ºè„šæœ¬ç¤ºä¾‹
```bash
#!/bin/bash
# build_optimized.sh

echo "ä¼˜åŒ–æ„å»º sing-box-manager..."

# è®¾ç½®æ„å»ºå‚æ•°
export CGO_ENABLED=0
export GOOS=linux
export GOARCH=amd64

# æ„å»º
go build \
    -ldflags="-s -w -X main.version=$(git describe --tags)" \
    -trimpath \
    -o dist/sbm \
    ./cmd/sbm

echo "æ„å»ºå®Œæˆ: dist/sbm"
ls -lh dist/sbm
```

---

## ğŸ“ˆ ç›‘æ§ä¸éªŒè¯

### å†…å­˜ä½¿ç”¨ç›‘æ§
```bash
# æŒç»­ç›‘æ§å†…å­˜
watch -n 1 'ps aux | grep sbm | grep -v grep | awk "{print \$6/1024 \" MB\"}"'

# æˆ–ä½¿ç”¨ pprof
curl http://localhost:9090/debug/pprof/heap > heap.prof
go tool pprof -http=:8080 heap.prof
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•
```go
// internal/storage/json_store_bench_test.go
package storage

import "testing"

func BenchmarkGetAllNodesPtr(b *testing.B) {
    store := setupTestStore()
    b.ResetTimer()

    for i := 0; i < b.N; i++ {
        _ = store.GetAllNodesPtr()
    }
}
```

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡å»ºè®®

### å½“å‰çŠ¶æ€
```
âœ… åˆå§‹å†…å­˜: 16-17 MB
âœ… è¿è¡Œç¨³å®š
âœ… ä¼˜äºåŒç±»äº§å“
```

### ä¼˜åŒ–ç›®æ ‡
| åœºæ™¯ | ç›®æ ‡å†…å­˜ | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|----------|----------|
| **æœåŠ¡å™¨éƒ¨ç½²** | 15-20 MB | æ–¹æ¡ˆ 1 + 2 |
| **å®¹å™¨ç¯å¢ƒ** | 12-15 MB | æ–¹æ¡ˆ 1 + 2 + 3 |
| **åµŒå…¥å¼è®¾å¤‡** | < 10 MB | æ–¹æ¡ˆ 1-5 å…¨éƒ¨ + TinyGo |

### æ€§ä»·æ¯”åˆ†æ
```
âœ… é«˜æ€§ä»·æ¯”: æ–¹æ¡ˆ 1 (ç¼–è¯‘ä¼˜åŒ–)
âœ… ä¸­æ€§ä»·æ¯”: æ–¹æ¡ˆ 2 (è¿è¡Œæ—¶å‚æ•°)
âš ï¸ ä½æ€§ä»·æ¯”: æ–¹æ¡ˆ 3-5 (æ”¶ç›Šå°ï¼Œæˆæœ¬é«˜)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¿‡åº¦ä¼˜åŒ–çš„é£é™©**
   - ä¸ºèŠ‚çœ 2-3 MB å¢åŠ ä»£ç å¤æ‚åº¦æ˜¯ä¸å€¼å¾—çš„
   - Go è¿è¡Œæ—¶éœ€è¦ä¸€å®šå†…å­˜æ‰èƒ½é«˜æ•ˆè¿è¡Œ

2. **GC å‚æ•°è°ƒä¼˜**
   - `GOGC` è®¾ç½®è¿‡ä½ä¼šå¢åŠ  GC é¢‘ç‡ï¼Œå½±å“æ€§èƒ½
   - `GOMEMLIMIT` åº”è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70-80%

3. **å†…å­˜ vs æ€§èƒ½æƒè¡¡**
   - æ›´å°çš„å†…å­˜å¯èƒ½å¯¼è‡´æ›´å¤šçš„ GC æš‚åœ
   - å»ºè®®ä¼˜å…ˆä¿è¯æ€§èƒ½

---

## ğŸ“Š ç»“è®º

**å½“å‰çŠ¶æ€**: âœ… **ä¼˜ç§€**

- 16-17 MB å¯¹äºåŠŸèƒ½å®Œæ•´çš„ Go Web æœåŠ¡å·²ç»å¾ˆä¼˜ç§€
- ä¼˜äº Caddyã€Traefik ç­‰åŒç±»äº§å“
- é™¤ééƒ¨ç½²åœ¨å†…å­˜æåº¦å—é™çš„ç¯å¢ƒï¼ˆ< 64 MBï¼‰ï¼Œå¦åˆ™ä¸å»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–

**æ¨èè¡ŒåŠ¨**:
1. âœ… ä½¿ç”¨ç¼–è¯‘ä¼˜åŒ– (`-ldflags="-s -w"`)
2. âš ï¸ å…¶ä»–ä¼˜åŒ–æŒ‰éœ€é€‰æ‹©ï¼Œé¿å…è¿‡åº¦å·¥ç¨‹
